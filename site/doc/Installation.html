<HTML>
<HEAD>
<TITLE> org.melati Installation Guide (document $Revision$) </TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso8859-1">
</HEAD>
<BODY BGCOLOR=#FFFFFF>

<H1><TT>org.melati</TT> Installation Guide (document $Revision$)</H1>

<P>
  This document describes how to install the system on a new machine.
  See also the system's <A HREF=QA.html>master QA document</A>, and
  its <A HREF=Administration.html>administration guide</A>.
</P>




<h3>Prerequisites </h3>
<h4> Hardware</h4>
<p> Since Melati is written entirely in Java, it is portable relatively easily 
  to any machine which supports the JVMs mentioned below. </p>
<h4> Software</h4>
<p> Melati has been proved to work in the following environments:</p>
<table width="75%" border="1" cellspacing="0" cellpadding="5">
  <tr> 
    <td>Operating System</td>
    <td> 
      <ul>
        <li>Linux 2.2.12 with glibc 2.1.1, 2.0.34/i586 with glibc 2.0.7. </li>
        <li> Win2000 | WinNT/i586 </li>
      </ul>
    </td>
  </tr>
  <tr> 
    <td>Web Server / Servlet Engine</td>
    <td> 
      <ul>
        <li>Apache 1.3.12 / JServ 1.1</li>
        <li>MS IIS 4.0 / Apache Tomcat 3.1 </li>
      </ul>
    </td>
  </tr>
  <tr> 
    <td>JDK</td>
    <td> 
      <blockquote> 
        <p>1.2, 1.3 </p>
      </blockquote>
    </td>
  </tr>
  <tr> 
    <td>JSDK</td>
    <td> 
      <blockquote>2.0, 2.2</blockquote>
    </td>
  </tr>
  <tr> 
    <td>Database</td>
    <td> 
      <blockquote>PostgreSQL 7.0 (and up)</blockquote>
    </td>
  </tr>
  <tr> 
    <td>Template Engine</td>
    <td> 
      <blockquote><a href=http://webmacro.org/Download.html>WebMacro</a> Snapshot 
        July 19, 2000 (Melati 0.51) or release 0.94 (with Melati 0.52).
        Available for download as <a href="http://germ.semiotek.com/wm/webmacro.19-07-2000.zip">zip</a> 
        or <a href="http://germ.semiotek.com/wm/webmacro.19-07-2000.tgz">tgz</a>. 
      </blockquote>
    </td>
  </tr>
</table>
<p>The JDBC facilities used by Melati are pretty simple, and we are aiming for 
  compatibility with any DBMS which supports JDBC and transactions, but for now 
  Postgresql is what we use, even though it is imperfect. </p>
<p>We expect Melati to run in most Servlet Environments (we just havn't tested 
  them all yet :)</p>
<p>&nbsp;</p>
<h2></h2>
<H2> <!-- ****************** --> Obtaining Melati <!-- ****************** --> 
</H2>



<P> Download the latest melati snapshot from <A
  HREF=http://melati.org><TT>http://melati.org</TT></A>, unzip or untar
  and follow the installation instructions. </P>
<H2>
<!-- ************** -->
      Implications
<!-- ************** -->
</H2>



<H3>
<!-- ================================= -->
      Interations with other software
<!-- ================================= -->
</H3>

<P>
  Melati interacts with other software in the following ways which you should
  know about:
</P>

<UL>
  <LI> you will have to restart your Melati application (<I>e.g.</I> with
       <TT>apachectl</TT> <TT>graceful</TT>) if Postgres goes down while it is
       running
</UL>



<H3>
<!-- =============== -->
      Risk analysis
<!-- =============== -->
</H3>

<P>
  The things that might be broken if you install the system on a computer are:
</P>

<UL>
  <LI> Database corruption. Melati has been used for a number of projects over 
    about 12 months, no corruption has ever been experienced 
  <LI> Insecurity. Although Melati provides a user authorization and access control 
    system, it isn't supposed to be indefeasible by the application programmer. 
    Bad programming can make your application insecure.
  <LI> Bugginess. Melati is excitingly short on bugs! Any that you find will be 
    jumped on :)
</UL>




<H2>
<!-- ************** -->
      Installation
<!-- ************** -->
</H2>



<H3>
<!-- ============== -->
      Step by step
<!-- ============== -->
</H3>

<P>
  It is assumed that you already have a working installation of Webmacro
  (<I>i.e.</I> web server, servlet runner, and Webmacro classes), and a working
  installation of Postgres or, presuming compatibility, another RDBMS.
</P>

<table width="0%" border="0" cellpadding="10" cellspacing="0">
  <tr> 
    <td valign="top">1.</td>
    <td>Set up a database for use by Melati. With Postgres this involves typing, 
      for example, <tt>createdb melatitest</tt> at the Linux prompt, as a user 
      who is allowed to create databases. </td>
  </tr>
  <tr> 
    <td valign="top">2.</td>
    <td>Arrange for the user in whose name your httpd runs---often, `<tt>nobody</tt>'---to 
      be able to connect to the test database and create tables in it. With Postgres 
      this is a no-op under the default `security' setup, assuming that your postmaster 
      is running on the same machine as your web server. </td>
  </tr>
  <tr> 
    <td valign="top">3.</td>
    <td> 
      <h3>Either</h3>
      <p>Download the latest Melati snapshot from <a href="http;//www.melati.org">www.melati.org</a>, 
        and unzip or untar it. eg: </p>
      <ul>
        <li>Unix users type: 
          <ul>
            <li><tt>cd /usr/local/</tt></li>
            <li> <tt>tar -xzf melati_0.52.1.tar.gz</tt></li>
            <li>for convenience, create a soft link: <tt>ln -s melati_0.52.1 melati 
              </tt></li>
          </ul>
        </li>
        <li>Windows users should use WinZip</li>
      </ul>
      <p>Follow the Installation instructions in the file README.html in the snapshot. 
      </p>
      <h3>Or</h3>
      <p><a name=hackedVariable> Using anonymous CVS, install the Melati source 
        tree somewhere. You also have to install a specially hacked version of 
        <tt>org.webmacro.engine.Variable</tt>. We are very sorry about this, but 
        there really is no alternative---lobby Justin to stop making everything 
        <tt>final</tt> and/or package-private!</a></p>
      <p> For instance, </p>
      <blockquote> 
        <pre>
$ cd /usr/local/melati
$ cvs -d :pserver:anonymous@melati.org:/usr/cvsroot login
(Logging in to anonymous@melati.org)
CVS password: anonymous
$ cvs -d :pserver:anonymous@melati.org:/usr/cvsroot checkout org/melati org/webmacro org/apache
</pre>
      </blockquote>
      Thereafter you will be able to get an updated snapshot by <tt>cd</tt>ing 
      to the Melati source tree and doing 
      <blockquote> 
        <pre>
$ cvs update
</pre>
      </blockquote>
      (CVS remembers the server from which the tree came in the control files 
      in the <tt>CVS</tt> subdirectories it creates, and the login/password you 
      gave in a file <tt>.cvspass</tt> in your home directory.) If you are working 
      over a slow link, you might find the <a
    href=http://rsync.samba.org/rsync/><tt>rsync</tt></a> program useful: it uses 
      clever checksum tricks, compression and pipelining to perform file comparison 
      and update quicker than you would think possible. Let us know if you would 
      like &quot;anonymous rsync&quot; access. </td>
  </tr>
  <tr> 
    <td valign="top">4.</td>
    <td>Ensure that the following is in your classpath. <br>
      <ul>
        <li>Java (<TT>jre/lib/rt.jar</TT>, remember, in JDK 1.2---not
            <TT>classes.zip</TT>)
        <li><TT>ApacheJServ.jar</TT>
        <li><TT>postgresql.jar</TT> from the Postgresql distribution; the Red
            Hat RPMS call this <TT>/usr/lib/pgsql/jdbc6.5-1.2.jar</TT>.  You
            need this even though Melati has its own Postgresql-specific
            classes which add some functionality to the standard drivers in
            order to overcome one of their shortcomings.
        <li><TT>jsdk.jar</TT>
        <li>the melati install directory, <b>before</b> the webmacro install
            directory (because of the <a href=#hackedVariable>hacked version of
            <tt>Variable</tt></a> you must use)
        <li>the webmacro install directory 
      </ul>
      <p>For example (on Linux boxes running a bash shell) this can be done by 
        editing <TT>~/.bash_profile</TT>, and adding the lines: 
      <blockquote> 
        <pre>CLASSPATH=&quot;$CLASSPATH:/usr/local/jdk1.2.2/jre/lib/rt.jar&quot;
CLASSPATH=&quot;$CLASSPATH:/usr/local/lib/ApacheJServ.jar&quot;
CLASSPATH=&quot;$CLASSPATH:/usr/local/lib/jsdk.jar&quot;
CLASSPATH=&quot;$CLASSPATH:/usr/lib/pgsql/jdbc6.5-1.2.jar&quot;
CLASSPATH=&quot;$CLASSPATH:/usr/local/melati/&quot;
CLASSPATH=&quot;$CLASSPATH:/usr/local/webmacro/webmacro.jar&quot;
export CLASSPATH</pre>
      </blockquote>
      <p>You will need to run</p>
      <pre>source ~/.bash_profile</pre>
      <p>in order to load the new CLASSPATH into you current environment settings---or, 
	if you have several windows plus an IDE open, you may choose to log 
	right out and in again. You can check the CLASSPATH has been set by 
	typing </p>
      <pre>echo $CLASSPATH</pre>
      <p>or more readably</p>
      <pre>echo $CLASSPATH | tr : \\n</pre>
    </td>
  </tr>
  <tr> 
    <td valign="top">5.</td>
    <td>
      <p>Compile melati. </p>
      <p>
        There is an <a href=http://jakarta.apache.org/ant/index.html>Ant</a> based build script in the org/melati/build directory.
      </p>
<BLOCKQUOTE>
        <PRE>
cd .../org/melati/build
sh build-melati.sh

</PRE></BLOCKQUOTE>
      Note: Assuming you have melati installed in a directory like 

      <BLOCKQUOTE><PRE>
    .../src/org/melati/...
</PRE></BLOCKQUOTE>

It will create a directory
<BLOCKQUOTE><PRE>
   .../dist/
</PRE></BLOCKQUOTE>

Which will contain all the compiled classes and additional files (*.wm, *.html, 
      *.gif and *.js) and a directory 
      <BLOCKQUOTE>
        <PRE>
   .../built/
</PRE>
      </BLOCKQUOTE>

Which will contain the melati jar file, the javadocs, a zip file of the sources, 
      and additional files (*.wm, *.html, *.gif and *.js)
<p></p>
        
<hr align=left width=50%>

      <p>
        Alternatively, all you need to do is:
      </p>
<BLOCKQUOTE>
        <PRE>
cd /usr/local/melati/org/melati
./compile.sh
</PRE>
      </BLOCKQUOTE>
<p>This will compile all of melati</p>

<hr align=left width=50%>

      <P>
        If you want to build Melati by hand, you should compile the following
        packages:
      </P>

      <BLOCKQUOTE> 
        <PRE>
org.melati
org.melati.admin
org.melati.login
org.melati.servlet
org.melati.template
org.melati.util
org.melati.poem
org.melati.poem.prepro
org.melati.poem.sql.jdbc2
org.melati.poem.postgresql.jdbc2
</PRE>
      </BLOCKQUOTE>
  </tr>
  <tr> 
    <td valign="top">6.</td>
    <td  valign=top> 
      <p><a name="6"></a>Arrange for Melati's classes and properties files to 
        be accessible to your servlet runner. </p>
      <p>For Apache Jserv, this can be done either in the <tt>jserv.properties</tt> 
        file, by adding a line </p>
        <blockquote> 
          <pre>
wrapper.classpath=/usr/local/melati
</pre>
        </blockquote>
        <p>or in your <tt>&lt;zone&gt;.properties</tt> file by adding </p>
        <blockquote> 
          <pre>/usr/local/melati</pre>
        </blockquote>
        
      <p>to the line beginning <tt>repositories=</tt></p>
      <p>NOTE: If you have downloaded the snapshot, or have build a .jar, you 
        must <b>additionally</b> reference the .jar in your .properties file:</p>
      <blockquote> 
        <pre>/usr/local/melati/melati-snapshot.jar</pre>
      </blockquote>
        
      </td>
  </tr>
  <tr> 
    <td valign="top">7.</td>
    <td  valign=top>
      <p>Arrange for Melati's statically served pages to be accessible via
         your web server.</p>
      <p></p>
        <p>
          By default, Melati will expect to find its JavaScript, images and
          static HTML under <TT>http://your.server/melati-static</TT>.
          To set this up with Apache, one typically does something like
        </p>
        <blockquote> 
          <pre>
ln -s /usr/local/melati/org/melati /usr/local/apache/htdocs/melati-static
</pre>
        </blockquote>
       <p>
         An alternate URL can be specified in the configuration file
         <tt>org/melati/org.melati.MelatiServlet.properties</tt>.
       </p>
    </td>
  </tr>
  <tr> 
    <td valign="top">8.</td>
    <td  valign=top>Get Melati's Webmacro templates into Webmacro's template 
      path. Melati looks for its templates relative to <tt>org/melati</tt> in 
      its source tree, so you should edit your <tt>WebMacro.properties</tt> to 
      say something like 
      <blockquote> 
        <pre>TemplatePath = /usr/local/melati/org/melati:/home/me/templates</pre>
      </blockquote>
    </td>
  </tr>
  <tr> 
    <td valign="top">9.</td>
    <td  valign=top>
      <P>
        <a name=config>Edit Melati's database config file</a>, found in 
	the source tree as
	<tt>org/melati/org.melati.LogicalDatabase.properties</tt>, which
	describes the mapping from &quot;logical database names&quot; to JDBC
	connection details.  You may not have to change anything.
      </P>

      <P>
        If you wish, you can also edit
        <TT>org.melati.MelatiServlet.properties</TT> (in the same directory) to
        choose between a login mechanism based on servlet sessions (<I>i.e.</I>
        cookies, which is the default) and one based on HTTP Basic
        Authorization (commonly used for password-protecting static pages).
        See <A
        HREF=javadoc/org/melati/MelatiServlet.html#loginmechanism>the
        javadoc</A>.
      </P>
    </td>
  </tr>
  <tr> 
    <td valign="top">10.</td>
    <td  valign=top>Restart your Servlet Runner, typically you will need to kick 
      apache using <tt>apachectl restart</tt>.</td>
  </tr>
  <tr>
    <td valign="top">11.</td>
    <td  valign=top> 
      <p>To check that Melati is working, try looking at </p>
      <blockquote> 
        <pre>
http://localhost/&lt;servlet zone&gt;/org.melati.test.ConfigServlet/
</pre>
      </blockquote>
      <p> This is the 1st servlet in the Melati Test suite. the test suite demonstrates 
        all teh features of melati, and gives you access to examples. It will 
        also help you debug yoiur installation</p>
      </td>
  </tr>
  <tr>
    <td valign="top">12.</td>
    <td  valign=top> 
      <p>If you are going to upload files using a form something like this: </p>
      <blockquote> 
<pre>
&lt;form method="post" enctype="multipart/form-data">
&lt;input type="file" name="file" enctype="multipart/form-data">
&lt;input type="submit" name="Submit" value="Upload file">
&lt;/form>
</pre>
      </blockquote>
      <p>then you should make sure that you store uploaded files in an appropriate way. Set
         <code>org.melati.MelatiServlet.formDataAdaptorFactory</code>
         in <code>org.melati.MelatiServlet.properties</code> appropriately. In particular, if
         you use <code>UploadURLPoemType.wm</code> as the renderinfo for a file (so that you
         can upload files using the Admin system) then you should probably set your
         <code>formDataAdaptorFactory</code> to <code>org.melati.servlet.PoemFileDataAdaptorFactory</code>
         and add <code>UploadDir</code> and <code>UploadURL</code> to your database's Setting
         table. This will upload files into the directory named by <code>UploadDir</code> and
         associate it with a URL of the form <code>UploadURL/<i>filename.ext</i></code></p>
      </td>
  </tr>
</table>

<H3>
<!-- ================= -->
      Troubleshooting
<!-- ================= -->
</H3>

<P>
  If something doesn't work, sorry!  Drop us an email at
  <A HREF=mailto:melati@messageboards.paneris.org>melati@messageboards.paneris.org</A>
  or <A HREF=mailto:williamc@paneris.org>williamc@paneris.org</A>.
</P>




<H2>
<!-- ******************************** -->
      Appendix: building from source
<!-- ******************************** -->
</H2>

<P>
  N/A at this stage.
</P>




<HR>

<H2>
<!-- ********************* -->
      About this document
<!-- ********************* -->
</H2>



<H3>
<!-- ========= -->
      Authors
<!-- ========= -->
</H3>

<P>
  <A HREF=mailto:williamc@paneris.org>William Chesters
  &lt;williamc@paneris.org&gt;</A>, <A HREF=mailto:timj@paneris.org>Tim Joyce
  &lt;timj@paneris.org&gt;</A>
</P>

<P>
  Most recent CVS $Author$ @paneris.org
</P>



<H3>
<!-- ========= -->
      Quality
<!-- ========= -->
</H3>

<P>
  The current quality level of this document is: <B>Personal</B>.  It's not
  finished.
</P>



<H3>
<!-- ======================== -->
      Readership and purpose
<!-- ======================== -->
</H3>

<UL>
  <LI> The <B>customer's admins</B> should know how to install the system from
       scratch on a new computer.

  <LI> So should <B>future developers</B>.
</UL>

<P>
  However, at present this document is primary intended to help the wider
  <B>open source community</B> get Melati running, so that they can give us
  feedback pre-release and evaluate the finished product in an informed manner.
</P>



<H3>
<!-- ========= -->
      History
<!-- ========= -->
</H3>

<P>
  The important points in the life of this document are listed
  below.
</P>

<TABLE>
  <TR><TH>Date</TH><TH>Event</TH></TR>
  <TR>
    <TD>(not yet)</TD>
    <TD>Certified at release quality level by ...</TD>
  </TR>
</TABLE>

<P>
  The CVS log for this document is:
  <BR>
  <BR>$Log$
  <BR>Revision 1.30  2001/02/06 12:22:45  mylesc
  <BR>Rejigging of file upload code
  <BR>
  <BR>Revision 1.29  2001/01/20 08:16:20  timj
  <BR>revisions for 0.52
  <BR>
  <BR>Revision 1.28  2000/11/16 11:07:20  timj
  <BR>final changes for 16/11/2000 snapshot
  <BR>
  <BR>Revision 1.27  2000/11/08 14:33:35  timj
  <BR>reduce risks
  <BR>
  <BR>Revision 1.26  2000/11/07 13:58:46  timj
  <BR>print stack traces when things go wrong
  <BR>
  <BR>Revision 1.24  2000/11/07 13:04:45  timj
  <BR>update for snapshot
  <BR>
  <BR>Revision 1.23  2000/09/11 11:35:22  kimptoc
  <BR>added some notes about the ant build script
  <BR>
  <BR>Revision 1.22  2000/07/31 13:18:32  kimptoc
  <BR>corrected webmacro info
  <BR>
  <BR>Revision 1.21  2000/07/23 15:39:00  kimptoc
  <BR>added org/apache to the check out option - as you need it
  <BR>
  <BR>Revision 1.20  2000/05/27 09:45:14  williamc
  <BR>Add instructions for setting up pointer to static content
  <BR>
  <BR>Revision 1.19  2000/04/15 18:39:36  williamc
  <BR>postgresql.jar is still called exactly that in the actual postgres sources
  <BR>
  <BR>Revision 1.18  2000/03/29 16:01:54  williamc
  <BR>Update for removal of JDK1.1 support
  <BR>
  <BR>Revision 1.17  2000/03/24 15:05:51  williamc
  <BR>commit to get log/revision right
  <BR>
  <BR>Revision 1.16  2000/03/24 14:47:27  williamc
  <BR>Introduce compile.sh; talk about JDBC1/2 support for Postgres workaround; tidy formatting further
  <BR>
  <BR>Revision 1.15  2000/03/22 16:38:35  timj
  <BR>improve formatting
  <BR>
  <BR>Revision 1.14  2000/03/22 15:54:35  williamc
  <BR>Make it clear that Justin encourages jikes too; update list of proven-compatible software; minor formatting glitches
  <BR>
  <BR>Revision 1.13  2000/03/22 13:44:27  timj
  <BR>more info about jikes, and better jserv classpath setting info
  <BR>
  <BR>Revision 1.12  2000/03/22 12:57:28  timj
  <BR>give an example of correctly setting the classpath
  <BR>
  <BR>Revision 1.11  2000/03/20 17:13:34  williamc
  <BR>Add comments about what to do after cvs checkout
  <BR>
  <BR>Revision 1.10  2000/03/08 11:44:36  williamc
  <BR>Add comments about hacked version of Variable
  <BR>
  <BR>Revision 1.9  2000/03/06 08:35:47  timj
  <BR>stop refering to webmacro.jar
  <BR>
  <BR>Revision 1.8  2000/03/05 21:57:57  timj
  <BR>fix little bits as per problems encountered when i did my 1st install
  <BR>
  <BR>Revision 1.7  2000/03/01 11:45:35  timj
  <BR>explicitly identify what needs to be in the classpath in order to compile
  <BR>
  <BR>Revision 1.6  2000/02/29 09:53:02  williamc
  <BR>Finish recovering from disaster; point out in the docs that you can 'add methods to table rows'
  <BR>
  <BR>
</P>


</BODY>
</HTML>
