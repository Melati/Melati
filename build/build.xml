<?xml version="1.0"?>

<project name="melati" default="help" basedir="." >
<property file="build.properties"/>

    <!-- ============================================= -->
    <description> Ant Build file for Melati </description>
    <!-- cvs="$Revision$"                        -->
    <!-- ============================================= -->

  <property name="version"            value="0.7.2"/>
  <property name="year"               value="2004"/>
  <property name="date"               value="26-04-2004"/>
  <property name="project"            value="melati"/>
  <property name="name"               value="Melati"/>
  <property name="build.sysclasspath" value="ignore"/>
  <property name="build.compiler"     value="modern"/>
  <property name="this.root"          value=".."/>
  <property name="src"                value="../src"/>
  <property name="build.lib"          value="../lib"/>
  <property name="built"              value="dist"/>
  <property name="built.root"         value="./${built}"/>
  <property name="compiled.root"      value="${built.root}/compiled"/>
  <property name="built.dir"          value="${built.root}/${project}_${version}"/>
  <property name="built.lib"          value="${built.dir}/lib"/>
  <property name="built.src"          value="${built.dir}/src"/>
  <property name="built.build"        value="${built.dir}/build"/>
  <property name="built.site"         value="${built.dir}/site"/>
  <property name="site"               value="../site"/>
  <property name="site.src"           value="../site/docsrc"/>
  <property name="xdocs"              value="../xdocs"/>
  <property name="javadoc.dir"        value="${site}/javadoc"/>
  <property name="doc.dir"            value="${site}/doc"/>
  <property name="packaged.dir"           value="${built.root}/packaged"/>
  <property name="war"                value="${packaged.dir}/${project}-${version}.war"/>
  <property name="jar"                value="${project}-${version}.jar"/>
  <property name="debug"              value="on"/>
  <property name="optimize"           value="off"/>
  <!-- We still use javax.servlet.HttpSession.getValue etc 
   for Servlet 2.0 compatibility -->
  <property name="deprecation"        value="off"/>
  <!-- We now assume Java 1.4. -->
  <property name="javac.source"       value="1.4"/>
  <property name="javadoc.source"     value="1.4"/>
  <property name="poemODMGDSD"        value="${src}/org/melati/example/odmg/odmg.dsd"/>

  <property name="melatiJar"        value="${jar}" />

  <property name="servletJar"       value="javax.servlet.jar"/>
  <property name="postgresqlJar"    value="pg73jdbc3.jar"/>
  <property name="hsqldbJar"        value="hsqldb-1.7.1.jar"/>
  <property name="mysqlJar"         value="mm.mysql-2.0.11-bin.jar" />
  <property name="sqlserverJar"     value="mssqlserver.jar" />
  <property name="msBaseJar"        value="msbase.jar" />
  <property name="msUtilJar"        value="msutil.jar" />
  <property name="mckoiJar"         value="mkjdbc.jar}" />

  <property name="webmacroJar"      value="webmacro-classic-2.0b1.jar"/>
  <property name="concurrentJar"    value="concurrent.jar"/>
  <property name="velocityJar"      value="velocity-1.3.1.jar" />
  <property name="oroJar"           value="jakarta-oro-2.0.8.jar" />
  <property name="collectionsJar"   value="commons-collections-3.0.jar" />
  <property name="odmgJar"          value="odmg3.jar" />

  <property name="junitJar"         value="junit.jar" />
  <property name="mockobjectsJar"   value="mockobjects-core-0.09.jar" />

  <path id="classpath.compile">
    <pathelement path="${build.lib}/${servletJar}"/>
    <pathelement path="${build.lib}/${postgresqlJar}"/>
    <pathelement path="${build.lib}/${webmacroJar}"/>
    <pathelement path="${build.lib}/${velocityJar}" />
    <pathelement path="${build.lib}/${oroJar}" />
    <pathelement path="${build.lib}/${collectionsJar}" />
    <pathelement path="${build.lib}/${odmgJar}" />
    <pathelement path="${build.lib}/${junitJar}" />
    <pathelement path="${build.lib}/${mockobjectsJar}" />
  </path>

  <path id="classpath.jetty">
    <pathelement path="${build.lib}/${servletJar}"/>
    <pathelement path="${build.lib}/javax.xml.jaxp.jar"/>
    <pathelement path="${build.lib}/org.apache.crimson.jar"/>
    <pathelement path="${build.lib}/org.apache.jasper.jar"/>
    <pathelement path="${build.lib}/org.mortbay.jetty.jar"/>
    <pathelement path="${build.lib}/tools.jar"/>

  </path>


    <!-- ================================================================= -->
    <!-- Help if no command given                                          -->
    <!-- ================================================================= -->

   <target name="help">
      <echo>
  This script requires Ant 1.5 or higher

usage:
   ant -help          display ant help screen
   ant help           display this message
   ant clean          delete the built directory
   ant compile        compile all sources
   ant jar            build the melati.jar
   ant war            build the melati.war
   ant zip            build the melati zips
   ant javadoc        create javadoc for the distribution package
   ant site           create website http://www.melati.org/
   ant run            run Jetty

   ant build         build everything from scratch 
   ant go            build everything from scratch and run it
   ant unittest       run unit tests

      </echo>      
   </target>


    <!-- ================================================================= -->
    <!-- Clean up the build directory                                      -->
    <!-- ================================================================= -->
    <target name="clean">
        <delete dir="${built.root}"/>
        <delete dir="${javadoc.dir}"/>
        <mkdir dir="${javadoc.dir}"/>
    </target>

    <!-- ================================================================= -->
    <!-- Compiles the source directory                                     -->
    <!-- ================================================================= -->
    <target name="compile">
      <mkdir dir="${compiled.root}"/>
  
      <javac srcdir="${src}"
             destdir="${compiled.root}"
             excludes="**/site/**/*.java"
             includes="**/*.java"
	     source="${javac.source}"
             debug="${debug}"
             deprecation="${deprecation}"
             optimize="${optimize}"
             classpathref="classpath.compile" 
       />
    </target>

    <!-- ================================================================= -->
    <!-- Copies the source files                                           -->
    <!-- ================================================================= -->
    <target name="sources">
      <!-- Copy the licence and readme -->
      <copy todir="${built.dir}">
        <fileset dir="${this.root}">
          <patternset>
            <include name="*.txt"/>
            <include name="*.html"/>
          </patternset>
        </fileset>
      </copy>

      <!-- Copy the source files -->
      <copy todir="${built.src}">
        <fileset dir="${src}">
          <patternset>
            <include name="**/*"/>
            <exclude name="**/*.class"/>
            <exclude name="**/*.zip"/>
            <exclude name="**/*.jar"/>
            <exclude name="**/dist/**"/>
            <exclude name="**/README.html"/>
            <exclude name="**/RELEASE-NOTES.html"/>
          </patternset>
        </fileset>
      </copy>

      <!-- Copy and rename the properties files -->
      <copy todir="${built.src}">
        <fileset dir="${src}">
          <patternset>
            <include name="**/*.properties.example"/>
          </patternset>
        </fileset>
      </copy>
    </target>
  
    <!-- ================================================================= -->
    <!-- Creates .jar and the .zip files                                   -->
    <!-- ================================================================= -->
    <target name="jar">
      <mkdir dir="${built.lib}"/>

      <!-- Do include the DSD and WM files in the jar -->
      <copy todir="${compiled.root}">
        <fileset dir="${src}">
          <patternset>
            <include name="**/*.wm"/>
            <!-- include name="**/*.dsd"/ -->
          </patternset>
        </fileset>
      </copy>
      <!-- The **/*.dsd currently does nothing because of a resource -->
      <!-- loader bug such that Poem.dsd must be a real file on the -->
      <!-- classpath. -->
      <!-- Not sure the above is true anymore, as the DSD wasn't in the jar -->
      <jar jarfile="${jar}"
           basedir="${compiled.root}"
           includes="**/*.class, **/*.dsd, **/*.wm"
       />
    </target>
    <target name="zip" depends="jar">
        <zip zipfile="${built.lib}/src.zip" 
            basedir="${src}" 
            includes="**/*.java"/>
        <zip zipfile="${built.lib}/example.zip" 
            basedir="${src}" 
            includes="org/melati/example/**/*"
            excludes="org/melati/example/**/CSV/*"/>
    </target>
    
    <!-- ================================================================= -->
    <!-- Run the pre-processor to generate the ODMG classes                -->
    <!-- ================================================================= -->
    <target name="preproODMGPlaying" depends="zip">
       <java classname="org.melati.poem.prepro.DSD"
             fork="yes"
             args="${poemODMGDSD}"
       />
    </target>

    <!-- ================================================================= -->
    <!-- Compile the ODMG source                                           -->
    <!-- ================================================================= -->
    <target name="compileODMGPlaying" depends="preproODMGPlaying">
      <javac srcdir      = "${src}"
             destdir     = "${built.src}"
             includes    = "org/melati/poem/example/odmg/**/*.java"
	     source="${javac.source}"
             debug       = "${debug}"
             deprecation = "${deprecation}"
             optimize    = "${optimize}"/>
    </target>
  
    <!-- =============================================================== -->
    <!-- Create the ODMG .jar file                                       -->
    <!-- =============================================================== -->
    <target name="jarODMGPlaying" depends="compileODMGPlaying">
      <jar jarfile  ="${built}/${project}.ODMGPlaying.jar"
           basedir  = "${built.src}"
           includes = "**/*.class **/*.properties"
      />
    </target>
    
    <!-- =========================================================== -->
    <!-- Run ODMG PlayingTest                                        -->
    <!-- =========================================================== -->
    <target name="runODMGPlaying" depends="jarODMGPlaying">
       <java classname="org.melati.example.odmg.OdmgTest"
             fork="yes"
       />
    </target>

    <!-- ============================================================= -->
    <!-- Generate Melati.org website                                   -->
    <!-- ============================================================= -->
  <target name="site"
          description="build site documentation">
    <delete>
       <fileset dir="${site}" includes="*.html"/>
    </delete>
    <loadfile property="header" srcFile="${site.src}/header.html"/>
    <loadfile property="footer" srcFile="${site.src}/footer.html"/>
    <loadfile property="menu" srcFile="${site.src}/menu.html"/>
    <loadfile property="sectionStartTagStart" 
              srcFile="${site.src}/xHTMLSectionStartTagStart.tag"/>
    <loadfile property="sectionStartTagEnd" 
              srcFile="${site.src}/xHTMLSectionStartTagEnd.tag"/>
    <property name="sectionEndTag" value=''/>
    <copy todir="${site}">
       <fileset dir="${site.src}" includes="*.ahtml"/>
       <filterset>
          <filter token="header"   value="${header}"/>
          <filter token="footer"   value="${footer}"/>
          <filter token="menu"     value="${menu}"/>
          <filter token="version"  value="${version}"/>
          <filter token="project"  value="${project}"/>
          <filter token="name"     value="${name}"/>
          <filter token="date"     value="${date}"/>
          <filter token="filename" value="${project}_${version}"/>
          <filter token="sectionStartTagStart" value="${sectionStartTagStart}"/>
          <filter token="sectionStartTagEnd" value="${sectionStartTagEnd}"/>
          <filter token="sectionEndTag" value="${sectionEndTag}"/>
       </filterset>
       <mapper type="glob" from="*.ahtml" to="*.html"/>
    </copy>
    
  </target>

    <!-- ============================================================= -->
    <!-- Generate maven.melati.org xdocs                               -->
    <!-- ============================================================= -->
  <target name="xdocs"
          description="build maven xdocs">
    <mkdir dir="${xdocs}"/>
    <delete>
       <fileset dir="${xdocs}" includes="*.xml" excludes="navigation.xml"/>
    </delete>
    <mkdir dir="${xdocs}/images"/>
    <loadfile property="Xheader" srcFile="${site.src}/header.xml"/>
    <loadfile property="Xfooter" srcFile="${site.src}/footer.xml"/>
    <loadfile property="Xmenu" srcFile="${site.src}/menu.xml"/>
    <loadfile property="XsectionStartTagStart" 
              srcFile="${site.src}/xMLSectionStartTagStart.tag"/>
    <loadfile property="XsectionStartTagEnd" 
              srcFile="${site.src}/xMLSectionStartTagEnd.tag"/>
    <loadfile property="XsectionEndTag" 
              srcFile="${site.src}/xMLSectionEndTag.tag"/>
    <copy todir="${xdocs}">
      <fileset dir="${site.src}" includes="*.ahtml" excludes="MailingList.html"/>
      <filterset>
        <filter token="header"   value="${Xheader}"/>
        <filter token="footer"   value="${Xfooter}"/>
        <filter token="menu"     value="${Xmenu}"/>
        <filter token="version"  value="${version}"/>
        <filter token="project"  value="${project}"/>
        <filter token="name"     value="${name}"/>
        <filter token="date"     value="${date}"/>
        <filter token="filename" value="${project}_${version}"/>
        <filter token="sectionStartTagStart" value="${XsectionStartTagStart}"/>
        <filter token="sectionStartTagEnd" value="${XsectionStartTagEnd}"/>
        <filter token="sectionEndTag" value="${XsectionEndTag}"/>
      </filterset>
      <mapper type="glob" from="*.ahtml" to="*.xml"/>
    </copy>
    <copy todir="${xdocs}/images">
      <fileset dir="${site}/images" />
    </copy>
    
  </target>

    <!-- ================================================================ -->
    <!-- Creates the API documentation                                    -->
    <!-- ================================================================ -->
    <target name="javadoc" description="API documentation">
      <!-- if running out of the distribution this may not exist -->
      <mkdir dir="${javadoc.dir}"/>
      <delete>
       <fileset dir="${javadoc.dir}" includes="*.html"/>
      </delete>
      <filter token="year"     value="${year}"/>
      <filter token="version"  value="${version}"/>
      <filter token="date"     value="${date}"/>        
      <javadoc
          sourcepath="${src}"
          sourcefiles=""
          classpathref="classpath.compile" 
          packagenames="org.*"
          destdir="${javadoc.dir}"
	  source="${javac.source}"
          author="true"
          private="true"
          version="true"
          use="true"
          header="a header"
          footer="a footer"
          windowtitle="${name} ${version} API"
          doctitle="${name} ${version} API"
          bottom="Copyright &#169; ${year} &lt;i&gt;${name}&lt;/i&gt;. All Rights Reserved."
        >
        <tag name="todo" description="To Do:"/>
        <tag name="generator" description="Generated by:"/>
      </javadoc>  
    </target>
    
    <!-- ================================================================= -->
    <!-- Package as .zip and .tgz                                          -->
    <!-- ================================================================= -->
    <target name="package" >
      <mkdir dir="${packaged.dir}"/>
      <copy todir="${built.lib}">
        <fileset dir="${build.lib}">
          <patternset>
            <include name="**/*.jar"/>
          </patternset>
        </fileset>
      </copy>
      <mkdir dir="${built.build}"/>
      <copy todir="${built.build}">
        <fileset dir=".">
          <patternset>
            <include name="**/*.xml"/>
            <exclude name="${built.root}/**/*.*"/>
          </patternset>
        </fileset>
      </copy>
      <mkdir dir="${built.site}"/>
      <copy todir="${built.site}">
        <fileset dir="${site}">
          <patternset>
            <exclude name="**/javadoc/**/*.*"/>
            <include name="**/*.*"/>
          </patternset>
        </fileset>
      </copy>

      <zip  basedir="${built.root}" 
            excludes="${compiled.root},${packaged.dir},**/*.zip"
            zipfile="${packaged.dir}/${project}_${version}.zip" />
      <tar  basedir="${built.root}" 
            excludes="${compiled.root},${packaged.dir},**/*.zip"
            tarfile="${packaged.dir}/${project}_${version}.tar" />
      <gzip src="${packaged.dir}/${project}_${version}.tar"
            zipfile="${packaged.dir}/${project}_${version}.tar.gz" />
      <zip  basedir="${javadoc.dir}"
            zipfile="${packaged.dir}/${project}_${version}_doc.zip" />
      <tar  basedir="${javadoc.dir}"
            tarfile="${packaged.dir}/${project}_${version}_doc.tar" />
      <gzip src="${packaged.dir}/${project}_${version}_doc.tar"
            zipfile="${packaged.dir}/${project}_${version}_doc.tar.gz" />
      <delete>
       <fileset dir="${packaged.dir}" includes="*.tar"/>
      </delete>
    </target>
    
    

    <!-- ================================================================= -->
    <!-- Build the .war                                                    -->
    <!-- ================================================================= -->
  <target name="war" depends="sources">
    <mkdir dir="${packaged.dir}"/>
    <delete file="${war}"/>
    <copy todir="${build.lib}" file="${jar}"/>
    <war warfile="${war}" webxml="${site}/WEB-INF/web.xml">
      <!-- The site HTML -->
      <fileset dir="${site}">
          <exclude name="**/docsrc/**"/>
          <exclude name="**/WEB-INF/**"/>
      </fileset>
      <!-- Readme and License -->
      <zipfileset dir="${this.root}"
                  prefix="melati-static">
          <include name="*.html"/>
          <include name="*.txt"/>
      </zipfileset>
      <!-- Individual java files referenced -->
      <zipfileset dir="${src}/org/melati/poem"
                  prefix="melati-static/poem"
                  includes="
                   PoemDatabase.java,
                   Poem.dsd"/>
      <zipfileset dir="${src}/org/melati/example/contacts"
                  prefix="melati-static/example/contacts">
          <include name="Search.java"/>
          <include name="contacts.dsd"/>
      </zipfileset>
      <!-- Source for Admin is referenced in site --> 
      <zipfileset dir="${src}/org/melati/admin" 
                  prefix="melati-static/admin">
          <exclude name="**/CVS/**"/>
          <exclude name="**/*.class"/>
      </zipfileset>
      <!-- Javadocs -->
      <zipfileset dir="${javadoc.dir}" 
                  prefix="javadoc">
          <include name="**/*.html"/>
          <include name="**/*.css"/>
      </zipfileset>
      <!-- Documentation  --> 
      <!-- Project documents -->
      <!-- Poem user guides -->
      <!-- Poem preprocessor user guide -->
      <zipfileset dir="${doc.dir}" 
                  prefix="doc">
          <exclude name="**/CVS/**"/>
          <exclude name="**/*.class"/>
      </zipfileset>
      <!-- Templets files -->
      <classes dir="${built.src}">
        <patternset>
          <include name="**/*.wm"/>
        </patternset>
      </classes>
      <!-- properties files -->
      <classes dir="${site}/properties">
        <patternset>
          <include name="**/*.properties"/>
        </patternset>
      </classes>
      <!-- Third party jars -->
      <lib dir="${build.lib}">
        <include name="${webmacroJar}"/>
        <include name="${hsqldbJar}"/>
        <include name="${concurrentJar}"/>
        <include name="${oroJar}" />
        <include name="${collectionsJar}" />

<!-- other possible libraries
        <include name="${postgresqlJar}"/>
        <include name="${velocityJar}" />
        <include name="${odmgJar}" />
        <include name="${junit}" />
-->
        <include name="${mysqlJar}" />
        <include name="${sqlserverJar}" />
        <include name="${msBaseJar}" />
        <include name="${msUtilJar}" />
        <include name="${melatiJar}"/>
      </lib>
    </war>
    <!-- don't want to have to refer to specific versions in jelly.xml -->
    <copy file="${war}" tofile="${packaged.dir}/${project}.war"/>
  </target>
  

    <!-- ============================================================== -->
    <!-- run Jetty with the specified configuration file                -->
    <!-- ============================================================== -->

  <target name="run" description="Launch Jetty">
    <java classname="org.mortbay.jetty.Server"
          classpathref="classpath.jetty"
          fork="yes"
          failonerror="yes">
      <jvmarg value="-Xmx256M"/>
      <arg line="jetty.xml"/>
    </java>
  </target>

    <!-- ============================================================== -->
    <!-- run Jetty w/the specified configuration file & remote debugger -->
    <!-- ============================================================== -->

  <target name="rundebug" description="Launch Jetty with remote debugging">
    <java classname="org.mortbay.jetty.Server"
          classpathref="classpath.jetty"
          fork="yes"
          failonerror="yes">
      <jvmarg value="-Xdebug"/>
	  <jvmarg value="-Xint"/>
	  <jvmarg value="-server"/>
	  <jvmarg value="-Xnoagent"/>
	  <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000"/>
      <arg line="jetty.xml"/>
    </java>
  </target>

    <!-- ============================================================== -->
    <!-- Run Unit tests                                                 -->
    <!-- ============================================================== -->
  <target name="unittest" description="run functional tests" depends="compile">
    <!-- Writing exceptions to output is particularly useful in emacs. -->
    <!-- Do not fail initially, copy output to stderr and then fail -->
    <!-- based on failure property. Not sure if ant provides other -->
    <!-- ways but emacs does if there is a problem with this. -->
    <junit printsummary="withOutAndErr"
	failureproperty="unitTestsFailed"
        filtertrace="off"
        showoutput="true">
      <formatter type="plain"/>
      <classpath>
        <pathelement path="${compiled.root}"/>
        <pathelement path="${build.lib}/${mockobjectsJar}" />
      </classpath>
      <test name="org.melati.AllUnitTests"/>
      <formatter type="plain"/>
    </junit>
    <concat>
      <filelist dir="." files="TEST-org.melati.AllUnitTests.txt"/>
    </concat>
    <fail if="unitTestsFailed" message="Unit tests failed"/>
  </target>

    <!-- ============================================================== -->
    <!-- Edit java, compile, test cycle                                 -->
    <!-- ============================================================== -->
  <target name="test" 
          description="build (excluding javadoc but without clean) and run"
          depends="compile, unittest, zip, sources, package, war, run">
  </target>
  <target name="compileJar" 
          description="Compile changed sources, test and build jar"
          depends="compile, unittest, zip">
  </target>

    <!-- ============================================================== -->
    <!-- Edit a template and test cycle                                 -->
    <!-- ============================================================== -->
  <target name="template" 
          description="build (excluding javadoc) and run"
          depends="sources, war, run">
  </target>

    <!-- ============================================================== -->
    <!-- Do all of it                                                   -->
    <!-- ============================================================== -->
  <target name="build" 
          description="build from scratch"
          depends="clean, compile, unittest, zip, javadoc, site, xdocs, sources, package, war">
  </target>
  <target name="go" 
          description="build from scratch and run"
          depends="build, run">
  </target>


    <!-- ============================================================== -->
    <!-- Tomcat 4                                                       -->
    <!-- ============================================================== -->
  <property name="tomcat"  location="/inst/tomcat"/>
  <path id="classpath.tomcat">
    <pathelement path="${build.lib}/tools.jar"/>
    <pathelement path="${tomcat}/server/lib/catalina.jar"/>
  </path>

  <target name="startTomcat" >
  	<java jar="${tomcat}/bin/bootstrap.jar"  
              classpathref="classpath.tomcat"
              fork="true">
	    <arg value="start"/>
	    <sysproperty key="java.endorsed.dirs" value="${tomcat}/common/endorsed"/> 
	    <sysproperty key="user.dir" value="${tomcat}/conf"/> 

    </java>
  </target>

  <target name="stopTomcat">
  	<java jar="${tomcat}/bin/bootstrap.jar"  
              classpathref="classpath.tomcat"
              fork="true">
	    <arg value="stop"/> 
	    <sysproperty key="user.dir" value="${tomcat}"/>
    </java>
  </target>

  <target name="deployTomcat">
      <copy todir="${tomcat}/webapps" file="${war}"/>
  </target>
  
  <target name="kick" depends="stopTomcat, deployTomcat, startTomcat"></target>

</project>

