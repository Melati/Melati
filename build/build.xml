<?xml version="1.0"?>

<project name="melati" default="help" basedir="." >

    <!-- ============================================= -->
    <description> Ant Build file for Melati </description>
    <!-- cvs="$Revision$"                        -->
    <!-- ============================================= -->

  <property name="version"            value="0.7.0"/>
  <property name="year"               value="2002"/>
  <property name="date"               value="11-12-2002"/>
  <property name="project"            value="melati"/>
  <property name="name"               value="Melati"/>
  <property name="build.sysclasspath" value="ignore"/>
  <property name="build.compiler"     value="modern"/>
  <property name="this.root"          value=".."/>
  <property name="src"                value="../src"/>
  <property name="site"               value="../site"/>
  <property name="build.lib"          value="./lib"/>
  <property name="built"              value="dist"/>
  <property name="built.root"         value="./${built}"/>
  <property name="compiled.root"      value="${built.root}/compiled"/>
  <property name="built.dir"          value="${built.root}/${project}_${version}"/>
  <property name="built.lib"          value="${built.dir}/lib"/>
  <property name="built.src"          value="${built.dir}/src"/>
  <property name="site"               value="../site"/>
  <property name="site.src"           value="../site/src"/>
  <property name="javadoc.dir"        value="${site}/javadoc"/>
  <property name="doc.dir"            value="${site}/doc"/>
  <property name="packaged"           value="${built.root}/packaged/"/>
  <property name="war"                value="${packaged}/${project}.war"/>
  <property name="debug"              value="on"/>
  <property name="optimize"           value="off"/>
  <!-- We still use javax.servlet.HttpSession.getValue etc 
   for Servlet 2.0 compatibility -->
  <property name="deprecation"        value="off"/>
  <property name="poemODMGDSD"        value="${src}/org/melati/poem/odmg/playing/Playing.dsd"/>


  <path id="classpath.compile">
    <pathelement path="${build.lib}/javax.servlet.jar"/>
    <pathelement path="${build.lib}/webmacro-1.0.jar"/>
    <pathelement path="${build.lib}/velocity-1.3-rc1.jar" />
    <pathelement path="${build.lib}/velocity-dep-1.3-rc1.jar" />
    <pathelement path="${build.lib}/odmg3.jar" />
  </path>

  <path id="classpath.jetty">
    <pathelement path="${build.lib}/javax.servlet.jar"/>
    <pathelement path="${build.lib}/javax.xml.jaxp.jar"/>
    <pathelement path="${build.lib}/org.apache.crimson.jar"/>
    <pathelement path="${build.lib}/org.apache.jasper.jar"/>
    <pathelement path="${build.lib}/org.mortbay.jetty.jar"/>
  </path>
  <path id="classpath.drivers">
    <pathelement path="${build.lib}/hsqldb.jar"/>
    <pathelement path="${build.lib}/mm.mysql-2.0.11-bin.jar" />
    <pathelement path="${build.lib}/mkjdbc.jar"/>
  </path>
  <path id="classpath.run">
    <path refid="classpath.jetty"/>
    <pathelement path="${war}"/>
  </path>


    <!-- ================================================================= -->
    <!-- Help if no command given                                          -->
    <!-- ================================================================= -->

   <target name="help">
      <echo>
  This script requires Ant 1.5 or higher

usage:
   ant -help          display ant help screen
   ant help           display this message
   ant clean          delete the built directory
   ant compile        compile all sources
   ant jar            build the melati.jar
   ant war            build the melati.war
   ant javadoc        create javadoc for the distribution package
   ant site           create website http://www.melati.org/
   ant run            run Jetty

   ant build         build everything from scratch 
   ant go            build everything from scratch and run it

      </echo>      
   </target>


    <!-- ================================================================= -->
    <!-- Clean up the build directory                                      -->
    <!-- ================================================================= -->
    <target name="clean">
        <delete dir="${built.root}"/>
    </target>

    <!-- ================================================================= -->
    <!-- Compiles the source directory                                     -->
    <!-- ================================================================= -->
    <target name="compile">
      <mkdir dir="${compiled.root}"/>
  
      <javac srcdir="${src}"
             destdir="${compiled.root}"
             excludes="**/playing/**/*.java,**/site/**/*.java"
             includes="**/*.java"
             debug="${debug}"
             deprecation="${deprecation}"
             optimize="${optimize}"
             classpathref="classpath.compile" 
       />
    </target>

    <!-- ================================================================= -->
    <!-- Copies the source files                                            -->
    <!-- ================================================================= -->
    <target name="sources">
      <copy todir="${built.src}">
        <fileset dir="${src}">
          <patternset>
            <include name="**/*"/>
            <exclude name="**/*.class"/>
            <exclude name="**/*.zip"/>
            <exclude name="**/*.jar"/>
            <exclude name="**/dist/**"/>
            <exclude name="**/README.html"/>
            <exclude name="**/RELEASE-NOTES.html"/>
          </patternset>
        </fileset>
      </copy>

      <copy todir="${built.dir}">
        <fileset dir="${this.root}">
          <patternset>
            <include name="*.txt"/>
            <include name="*.html"/>
          </patternset>
        </fileset>
      </copy>

      <copy todir="${built.src}">
        <fileset dir="${src}">
          <patternset>
            <include name="**/*.properties.example"/>
            <exclude name="**/dist/**"/>
          </patternset>
        </fileset>
        <mapper type="glob" from="*.properties.example" to="*.properties"/>
      </copy>
    </target>
  
    <!-- ================================================================= -->
    <!-- Creates .jar and the .zip files                                   -->
    <!-- ================================================================= -->
    <!-- don't include properties and wm files in jar -->
    <target name="jar">
        <mkdir dir="${built.lib}"/>
        <jar jarfile="${built.lib}/${project}.jar"
            basedir="${compiled.root}"
            includes="**/*.class, **/*.dsd"
        />
        <zip zipfile="${built.lib}/src.zip" 
            basedir="${src}" 
            includes="**/*.java"/>
        <zip zipfile="${built.lib}/example.zip" 
            basedir="${src}" 
            includes="org/melati/example/contacts/**/*"
            excludes="org/melati/example/contacts/**/CSV/*"/>
    </target>
    
    <!-- ================================================================= -->
    <!-- Run the pre-processor to generate the ODMG classes                -->
    <!-- ================================================================= -->
    <target name="preproODMGPlaying" depends="jar">
       <java classname="org.melati.poem.prepro.DSD"
             fork="yes"
             args="${poemODMGDSD}"
       />
    </target>

    <!-- ================================================================= -->
    <!-- Compile the ODMG source                                           -->
    <!-- ================================================================= -->
    <target name="compileODMGPlaying" depends="preproODMGPlaying">
      <javac srcdir      = "${src}"
             destdir     = "${built.src}"
             includes    = "org/melati/poem/odmg/playing/**/*.java"
             debug       = "${debug}"
             deprecation = "${deprecation}"
             optimize    = "${optimize}"/>
    </target>
  
    <!-- =============================================================== -->
    <!-- Create the ODMG .jar file                                       -->
    <!-- =============================================================== -->
    <target name="jarODMGPlaying" depends="compileODMGPlaying">
      <jar jarfile  ="${built}/${project}.ODMGPlaying.jar"
           basedir  = "${built.src}"
           includes = "**/*.class **/*.properties"
      />
    </target>
    
    <!-- =========================================================== -->
    <!-- Run ODMG PlayingTest                                        -->
    <!-- =========================================================== -->
    <target name="runODMGPlaying" depends="jarODMGPlaying">
       <java classname="org.melati.poem.odmg.playing.PlayingTest"
             fork="yes"
       />
    </target>

    <!-- ============================================================= -->
    <!-- Generate Melati.org website                                   -->
    <!-- ============================================================= -->
  <target name="site"
          description="build site documentation">
    <delete>
       <fileset dir="${site}" includes="*.html"/>
    </delete>
    <loadfile property="header" srcFile="${site.src}/header.html"/>
    <loadfile property="footer" srcFile="${site.src}/footer.html"/>
    <loadfile property="menu" srcFile="${site.src}/menu.html"/>
    <filter token="header"   value="${header}"/>
    <filter token="footer"   value="${footer}"/>
    <filter token="menu"     value="${menu}"/>
    <filter token="version"  value="${version}"/>
    <filter token="project"  value="${project}"/>
    <filter token="name"     value="${name}"/>
    <filter token="date"     value="${date}"/>
    <filter token="filename" value="${project}_${version}"/>
    <copy todir="${site}" filtering="true">
       <fileset dir="${site.src}"/>
       <mapper type="glob" from="*.ahtml" to="*.html"/>
    </copy>
    
  </target>

    <!-- ================================================================ -->
    <!-- Creates the API documentation                                    -->
    <!-- ================================================================ -->
    <target name="javadoc">
      <!-- if running out of the distribution this may not exist -->
      <mkdir dir="${javadoc.dir}"/>
      <delete>
       <fileset dir="${javadoc.dir}" includes="*.html"/>
      </delete>
      <filter token="year"     value="${year}"/>
      <filter token="version"  value="${version}"/>
      <filter token="date"     value="${date}"/>        
      <javadoc
          sourcepath="${src}"
          sourcefiles=""
          classpathref="classpath.compile" 
          packagenames="org.*"
          destdir="${javadoc.dir}"
          author="true"
          private="true"
          version="true"
          use="true"
          header="a header"
          footer="a footer"
          windowtitle="${name} ${version} API"
          doctitle="${name} ${version} API"
          bottom="Copyright &#169; ${year} &lt;i&gt;${name}&lt;/i&gt;. All Rights Reserved."
        />
    </target>
    
    <!-- ================================================================= -->
    <!-- Package as .zip and .tgz                                          -->
    <!-- ================================================================= -->
    <target name="package" >
       <mkdir dir="${packaged}"/>
       <zip  basedir="${built.root}" 
             excludes="${compiled.root},${packaged},**/*.zip"
             zipfile="${packaged}/${project}_${version}.zip" />
       <tar  basedir="${built.root}" 
             excludes="${compiled.root},${packaged},**/*.zip"
             tarfile="${packaged}/${project}_${version}.tar" />
       <gzip src="${packaged}/${project}_${version}.tar"
             zipfile="${packaged}/${project}_${version}.tar.gz" />
       <zip  basedir="${javadoc.dir}"
             zipfile="${packaged}/${project}_${version}_doc.zip" />
       <tar  basedir="${javadoc.dir}"
             tarfile="${packaged}/${project}_${version}_doc.tar" />
       <gzip src="${packaged}/${project}_${version}_doc.tar"
             zipfile="${packaged}/${project}_${version}_doc.tar.gz" />
       <delete>
        <fileset dir="${packaged}" includes="*.tar"/>
       </delete>
    </target>
    
    

    <!-- ================================================================= -->
    <!-- Build the .war                                                    -->
    <!-- ================================================================= -->
  <target name="war">
    <delete file="${war}"/>
    <war warfile="${war}" webxml="web.xml">
      <!-- The site HTML -->
      <fileset dir="${site}">
          <exclude name="**/src/**"/>
      </fileset>
      <!-- Readme and License -->
      <zipfileset dir="${this.root}"
                  prefix="melati-static">
          <include name="*.html"/>
          <include name="*.txt"/>
      </zipfileset>
      <!-- Individual java files referenced -->
      <zipfileset dir="${src}/org/melati/poem"
                  prefix="melati-static/poem">
          <include name="PoemDatabase.java"/>
      </zipfileset>
      <zipfileset dir="${src}/org/melati/example/contacts"
                  prefix="melati-static/example/contacts">
          <include name="Search.java"/>
          <include name="contacts.dsd"/>
      </zipfileset>
      <!-- Source for Admin is referenced in site --> 
      <zipfileset dir="${src}/org/melati/admin" 
                  prefix="melati-static/admin">
          <exclude name="**/CVS/**"/>
          <exclude name="**/*.class"/>
      </zipfileset>
      <!-- Javadocs -->
      <zipfileset dir="${javadoc.dir}" 
                  prefix="javadoc">
          <include name="**/*.html"/>
          <include name="**/*.css"/>
      </zipfileset>
      <!-- Documentation  --> 
      <!-- Project documents -->
      <!-- Poem user guides -->
      <!-- Poem preprocessor user guide -->
      <zipfileset dir="${doc.dir}" 
                  prefix="doc">
          <exclude name="**/CVS/**"/>
          <exclude name="**/*.class"/>
      </zipfileset>
      <!-- Templets and properties files -->
      <fileset dir="${built.src}">
        <patternset>
          <include name="**/*.properties"/>
          <include name="**/*.wm"/>
        </patternset>
      </fileset>
      <!-- Third party jars -->
      <lib dir="${build.lib}">
        <include name="webmacro-1.0.jar"/>
        <include name="hsqldb.jar"/>
      </lib>
      <!-- Melati jar -->
      <lib dir="${built.lib}">
        <include name="${project}.jar"/>
      </lib>
    </war>
  </target>
  

    <!-- ============================================================== -->
    <!-- run Jetty with the specified configuration file                -->
    <!-- ============================================================== -->

  <target name="run" description="Launch Jetty">
    <java classname="org.mortbay.jetty.Server"
          classpathref="classpath.run"
          fork="yes"
          failonerror="yes">
      <arg line="jetty.xml"/>
    </java>
  </target>


    <!-- ============================================================== -->
    <!-- Do all of it                                                   -->
    <!-- ============================================================== -->
  <target name="build" 
          description="build from scratch"
          depends="clean, compile, jar, javadoc, site, sources, package, war">
  </target>
  <target name="go" 
          description="build from scratch and run"
          depends="build, run">
  </target>

    <!-- ============================================================== -->
    <!-- Edit, compile, test cycle                                      -->
    <!-- ============================================================== -->
  <target name="test" 
          description="build (excluding javadoc) and run"
          depends="clean, compile, jar, sources, package, war, run">
  </target>
    <!-- ============================================================== -->
    <!-- Edit, compile, test cycle                                      -->
    <!-- ============================================================== -->
  <target name="template" 
          description="build (excluding javadoc) and run"
          depends="sources, war, run">
  </target>
</project>










