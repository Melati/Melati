<HTML>
<HEAD>
<TITLE> org.melati Internals Description
        (document $Revision$) </TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso8859-1">
</HEAD>
<BODY BGCOLOR=#FFFFFF>

<H1><TT>org.melati</TT> Internals Description
    (document $Revision$)</H1>

<P>
  This document provides a description of anything noteworthy in the
  workings of the system.  See also the system's
  <A HREF=QA.html>master QA document</A>.
</P>




<H2>
<!-- ************* -->
      Foundations
<!-- ************* -->
</H2>



<H3>
<!-- ================================== -->
      Global data structure and format
<!-- ================================== -->
</H3>

<P>
  The fundamental data structures used in the system are:
</P>

<P>
  <I> ... data dictionary; content management of static web pages;
  admin configuration</I>
</P>



<H3>
<!-- ============= -->
      Data access
<!-- ============= -->
</H3>

<P>
  The interface through which the code accesses the data is:
</P>

<P>
  ...
</P>



<H3>
<!-- ===================== -->
      Pervasive libraries
<!-- ===================== -->
</H3>

<P>
  The libraries that underpin large parts of the project are:
</P>

<P>
  ... <I>the litmus test is ``Will I have to change vast
  amounts of other code if I change this?''</I>
</P>



<H3>
<!-- =========================== -->
      Pervasive graphic designs
<!-- =========================== -->
</H3>

<P>
  The graphic designs that have wide implications for the
  layout of the system's interfaces are:
</P>

<P>
  ...
</P>



<H2><A NAME=sub-parts>
<!-- *********** -->
      Sub-parts
<!-- *********** -->
</A></H2>

<P>
  The parts into which the system naturally falls are:
</P>

<P>
  ... <I>minimise the ``surface'' area of interface; make each piece
  doable by at most two developers; describe the interface it offers
  and the other parts it relies on; include graphics designs</I>
</P>



<H3><A NAME=dsd-proc>
<!-- ===================================== -->
      Data structure definition processor
<!-- ===================================== -->
</A></H3>


<H4>
<!-- -------- -->
      Parser
<!-- -------- -->
</H4>

<P>
  The <A HREF=FunctionalSpecification.html#dsd-example>language</A> is simple.
  The only wrinkle is that the definitions are recursive.  So we use a simple
  custom top-down parser (with, obviously, Java's library tokenizer).
</P>


<H4>
<!-- ----------------------- -->
      Base class generation
<!-- ----------------------- -->
</H4>

<P>
  The auto-generated base classes for the business objects wrapping the table
  rows are quite simple, because most of the logic of fetching and interpreting
  table rows sits in the <TT>Table</TT> itself (including invalidation of
  cached rows when the schema is changed).
</P>


<H4>
<!-- ------------------------------- -->
      Database structure generation
<!-- ------------------------------- -->
</H4>

<P>
  Some more auto-generated code needs to describe the minimum database scheme
  the app expects to find, including indexes.
</P>



<H3>
<!-- ================================= -->
      Runtime of the persistent store
<!-- ================================= -->
</H3>


<H4>
<!-- ---------------- -->
      Representation
<!-- ---------------- -->
</H4>

<P>
  Persistent objects are always represented to the user by the same
  <TT>Record</TT>, whatever the current (thread-relative) access token and
  transaction.  This means that <TT>==</TT> tests between <TT>Record</TT>s will
  work as expected, and minimises the consequences of programmers storing
  references in data structures of their own which carry over between sessions
  or adding data members when the extend the auto-generated base classes.
</P>

<P>
  The object's fields array is obtained by a method call, because it depends on
  the current transaction, but this doesn't involve a hashtable lookup: the
  object has space for pointers to two field arrays, one for the committed
  cache and one for the (almost always) only session in which the object has
  been pencilled in for a modification.  In the rare case that more than one
  session-cached version is needed, a list is introduced.
</P>

<P>
  Alternatively: fetching the field array always involves a hash lookup in both
  the session cache and the committed cache---a little slower, but makes it
  easier to invalidate caches.
</P>


<H4>
<!-- ----------- -->
      The cache
<!-- ----------- -->
</H4>

<P>
  <FONT COLOR=red>What happens if the administrator changes the database while
  a write is being prepared?  It needs to fail.  E.g. enumeration of generic
  fields can produce odd results in this case.</FONT>
</P>

<P>
  We know everything that can possibly have changed in a session, since we
  forbid SQL <TT>UPDATE</TT>s which are not mediated through setter methods.
  So everything that comes in from the database and is not already in the
  session cache can go straight into the committed cache.
</P>


<H4>
<!-- --------- -->
      Subsets
<!-- --------- -->
</H4>

<P>
  Need to be able to: select themselves out of the db with a prepared
  statement; trigger to be changed when a field of a record is changed.
</P>



<H3>
<!-- ============== -->
      Admin system
<!-- ============== -->
</H3>


<H4>
<!-- ---------------------------------------------- -->
      How does <TT>Admin.java</TT> work currently?
<!-- ---------------------------------------------- -->
</H4>

<TABLE>
  <TR>
    <TH>`Action'</TH>
    <TH>Incoming <TT>.wm</TT></TH>
    <TH>Function</TH>
    <TH>Outgoing <TT>.wm</TT></TH>
  </TR>

  <TR>
    <TD><TT>tables</TT></TD>
    <TD>various</TD>
    <TD>
      list tables in database
    </TD>
    <TD><TT>AdministrationTables1</TT></TD>
  </TR>

  <TR>
    <TD><TT>select</TT></TD>
    <TD>various</TD>
    <TD>
      ``Get all relevant drop boxes to SELECT a set of records and perhaps LIST
      them or LISTEDIT them'' [yeah right, as you do].  I think this means: the
      screen where you choose the criteria by which you want a report of
      records from a table.
    </TD>
    <TD><TT>AdministrationEditList1</TT>, <TT>AdministrationList1</TT></TD>
  </TR>

  <TR>
    <TD><TT>briefselect</TT></TD>
    <TD><TT>select_frameset2.wm</TT></TD>
    <TD>
      ``Get one drop boxes to BRIEFSELECT a set of records (the "first" select
      box)''.  I have no idea what this does.
    </TD>
    <TD><TT>select2.wm</TT></TD>
  </TR>

  <TR>
    <TD><TT>display</TT></TD>
    <TD>none, apparently</TD>
    <TD>
      ``DISPLAY one record.''  Dead simple.
    </TD>
    <TD><TT>AdministrationDisplay1</TT></TD>
  </TR>

  <TR>
    <TD><TT>edit</TT></TD>
    <TD>various</TD>
    <TD>
      ``EDIT one record.''  I don't understand <TT>UploadURL</TT>.
    </TD>
    <TD>
       <TT>AdministrationEdit1</TT>; <TT>AdministrationEditPageContents1</TT>
    </TD>
  </TR>

  <TR>
    <TD><TT>update</TT></TD>
    <TD>
      <TT>AdministrationEdit1</TT>; <TT>AdministrationEditPageContents1</TT>;
      <TT>edit2</TT>; <TT>editadd2</TT>
    </TD>
    <TD>
      ``UPDATE one record.''  Handles incoming add/edit/delete.
    </TD>
    <TD><TT>AdministrationUpdate1</TT></TD>
  </TR>

  <TR>
    <TD><TT>update multiple</TT> when not <TT>add_button</TT></TD>
    <TD><TT><TT>AdministrationEdit1.wm</TT>; <TT>editlist2.wm</TT></TD>
    <TD>
      ``UPDATE MULTIPLE records.''  Apparently handles incoming
      `add/edit/delete all'.  Don't understand.
    </TD>
    <TD><TT>AdministrationMultipleUpdate1</TT></TD>
  </TR>

  <TR>
    <TD><TT>update multiple</TT> when <TT>add_button</TT></TD>
    <TD><TT><TT>AdministrationEdit1.wm</TT>; <TT>editlist2.wm</TT></TD>
    <TD>
      ``ADD a new record to a MULTIPLE records list.''  Apparently handles
      incoming `add'.  Don't understand.
    </TD>
    <TD><TT>AdministrationEditList1</TT></TD>
  </TR>
</TABLE>




<H2>
<!-- ****************** -->
      Important issues
<!-- ****************** -->
</H2>



<H3>
<!-- ============= -->
      Performance
<!-- ============= -->
</H3>

<P>
  The system meets its performance requirements because:
</P>

<P>
  ... <I>refer to the
  <A HREF=Requirements.html#performance>requirements analysis</A></I>
</P>



<H3>
<!-- ========== -->
      Security
<!-- ========== -->
</H3>

<P>
  The system is secure because:
</P>

<P>
  ... <I>refer to the
  <A HREF=Requirements.html#security>requirements analysis</A></I>
</P>



<H3>
<!-- ============ -->
      Robustness
<!-- ============ -->
</H3>

<P>
  The system is robust because:
</P>

<P>
  ... <I>refer to the
  <A HREF=Requirements.html#robustness>requirements analysis</A></I>
</P>



<H3>
<!-- =========== -->
      Stability
<!-- =========== -->
</H3>

<P>
  The system is stable because:
</P>

<P>
  ... <I>refer to the
  <A HREF=Requirements.html#stability>requirements analysis</A></I>
</P>




<H2>
<!-- *************** -->
      Risk analysis
<!-- *************** -->
</H2>

<P>
  The obvious ways in which this scheme might be flawed are:
</P>

<P>
  ...
</P>


<HR>




<H2>
<!-- ********************* -->
      About this document
<!-- ********************* -->
</H2>



<H3>
<!-- ========= -->
      Authors
<!-- ========= -->
</H3>

<P>
  <A HREF=mailto:williamc@paneris.org>William Chesters
  &lt;williamc@paneris.org&gt;</A>
</P>

<P>
  Most recent CVS $Author$ @paneris.org
</P>



<H3>
<!-- ========= -->
      Quality
<!-- ========= -->
</H3>

<P>
  The current quality level of this document (including any
  computer-generated documentation, such as javadoc, which belongs
  with it) is: <B>Personal</B>.
  <!-- Waived Personal Alpha Beta Release -->
</P>

<P>
  These are simply my scrappy working notes.  I justify this by saying that
  it's only me developing the core code, and that will be its own best
  documentation (along with a <I>post hoc</I> description of the mechanisms).
</P>



<H3>
<!-- ======================== -->
      Readership and purpose
<!-- ======================== -->
</H3>

<P>
  <UL>
    <LI> The <B>project leader</B> should feel happy about
	 how the system will be implemented.
    <LI> The <B>developers</B> should know as far as possible what
	 they are going to do.
    <LI> <B>Future maintainers</B> should be able to understand
	 any non-obvious details about how the system works.
  </UL>
</P>



<H3>
<!-- ========= -->
      History
<!-- ========= -->
</H3>

<P>
  The important points in the life of this document are listed
  below (for everyday update information, consult its CVS log).
</P>

<TABLE>
  <TR><TH>Date</TH><TH>Event</TH></TR>
  <TR>
    <TD>(not yet)</TD>
    <TD>Approved at release quality level by ...</TD>
  </TR>
</TABLE>

<P>
  <BR>$Log$
  <BR>Revision 1.3  2000/02/05 10:24:55  williamc
  <BR>Scrappy notes, but will put up anyway
  <BR>
  <BR>Revision 1.2  2000/02/04 18:28:34  williamc
  <BR>Add QA stub; explain DSD-admin interactino a little better
  <BR>
  <BR>
</P>


</BODY>
</HTML>
