<?xml version="1.0"?>

<!-- Ant Build file for Melati -->
<!-- cvs="$Id Exp $" -->

<project name="melati" default="main" basedir="." >

    <target name="init">
        <property name="Name" value="melati"/>
        <property name="version" value="0.54"/>
        <property name="project" value="melati"/>
        <property name="build.compiler" value="${JAVAC}"/>
        <property name="build.root" value="../../.."/>
        <property name="build.dist" value="../../../../dist"/>
        <property name="build.dist.src" value="${build.dist}/src"/>
        <property name="build.built.root" value="../../../../built"/>
        <property name="build.built" value="${build.built.root}/${project}_${version}"/>
        <property name="build.doc.root" value="../../../../doc"/>
        <property name="build.doc" value="${build.doc.root}/${project}_${version}/doc"/>
        <property name="build.lib" value="${build.built}/lib"/>
        <property name="build.src" value="${build.built}/src"/>
        <property name="final.name" value="package"/>
        <property name="final.dir" value="../../../../${final.name}/"/>
        <property name="year" value="2000"/>
        <property name="ant.home" value="."/>
        <property name="debug" value="on"/>
        <property name="optimize" value="off"/>
        <property name="deprecation" value="on"/>
        
        <property name="poemODMGDSD" value="${build.root}/org/melati/poem/odmg/playing/Playing.dsd"/>
        
        <filter token="year" value="${year}"/>
        <filter token="version" value="${version}"/>
        <filter token="date" value="${TODAY}"/>        
    </target>

    <!-- =================================================================== -->
    <!-- Prepares the build directory                                        -->
    <!-- =================================================================== -->
    <target name="prepare" depends="init">
        <mkdir dir="${build.dist}"/>
        <mkdir dir="${build.built}"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="**/*.properties"
            excludes="**/poem/odmg/playing/**/*.properties"
            filtering="on"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="**/*.properties.example"
            filtering="on"/>
        <renameext srcDir="${build.dist.src}" 
            includes="**/*.properties.example" 
            fromExtension=".properties.example" 
            toExtension=".properties" 
            replace="true"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="**/*.wm"
            excludes="**/doc/example/*.wm **/playing/**/*.wm"
            filtering="on"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="**/*.js"
            filtering="on"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="org/melati/admin/**/*.html"
            filtering="on"/>
        <copydir src="${build.root}" dest="${build.dist.src}"
            includes="org/melati/admin/**/*.gif"
            filtering="on"/>
        <copydir src="${build.root}/org/melati" dest="${build.dist}"
            includes="*.html"
            filtering="on"/>
        <copydir src="${build.root}/org/melati" dest="${build.dist}"
            includes="*.txt"
            filtering="on"/>

    </target>

    <!-- =================================================================== -->
    <!-- Compiles the source directory                                       -->
    <!-- =================================================================== -->
    <target name="compile" depends="prepare">
        <javac srcdir="${build.root}"
            destdir="${build.dist.src}"
            includes="**/*.java"
            excludes="**/playing/**/*.java"
            debug="${debug}"
            deprecation="${deprecation}"
            optimize="${optimize}"/>
    </target>
  
    <!-- =================================================================== -->
    <!-- Compiles the source directory and creates a .jar file               -->
    <!-- =================================================================== -->
<!-- don't include properties and wm files in jar -->
    <target name="jar" depends="compile">
        <mkdir dir="${build.lib}"/>
        <jar jarfile="${build.lib}/${project}.jar"
            basedir="${build.dist.src}"
            includes="**/*.class"
        />
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.js"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.properties"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.wm"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.html"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.gif"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.txt"
            filtering="on"/>
        <copydir src="${build.dist}" dest="${build.built}"
            includes="**/*.html"
            filtering="on"/>
        <zip zipfile="${build.lib}/src.zip" 
            basedir="${build.root}" 
            includes="**/*.java"/>
        <zip zipfile="${build.lib}/example.zip" 
            basedir="${build.root}" 
            includes="org/melati/doc/example/contacts/**/*"
            excludes="org/melati/doc/example/contacts/**/CSV/*"/>
    </target>
    
    <!-- =================================================================== -->
    <!-- Runs the pre-processor to generate the poem support classes         -->
    <!-- =================================================================== -->
    <target name="preproODMGPlaying" depends="jar">
       <java classname="org.melati.poem.prepro.DSD"
             fork="yes"
             args="${poemODMGDSD}"
             jvmargs=""
       />
    </target>

    <!-- =================================================================== -->
    <!-- Compiles the source directory                                       -->
    <!-- =================================================================== -->
    <target name="compileODMGPlaying" depends="preproODMGPlaying">
        <javac srcdir="${build.root}"
            destdir="${build.dist.src}"
            includes="org/melati/poem/odmg/playing/**/*.java"
            debug="${debug}"
            deprecation="${deprecation}"
            optimize="${optimize}"/>
    </target>
  
    <!-- =================================================================== -->
    <!-- Compiles the source directory and creates a .jar file               -->
    <!-- =================================================================== -->
    <target name="jarODMGPlaying" depends="compileODMGPlaying">
        <jar jarfile="${build.built}/${project}.ODMGPlaying.jar"
            basedir="${build.dist.src}"
            includes="**/*.class **/*.properties"
        />
    </target>
    
    <!-- =================================================================== -->
    <!-- Runs the pre-processor to generate the poem support classes         -->
    <!-- =================================================================== -->
    <target name="runODMGPlaying" depends="jarODMGPlaying">
       <java classname="org.melati.poem.odmg.playing.PlayingTest"
             fork="yes"
             args=""
             jvmargs=""
       />
    </target>

    <!-- =================================================================== -->
    <!-- Creates the API documentation                                       -->
    <!-- =================================================================== -->
    <target name="javadocs" depends="prepare">
        <mkdir dir="${build.doc}"/>
        <javadoc
            sourcepath="${build.root}"
            sourcefiles=""
            packagenames="org.*"
            destdir="${build.doc}"
            author="true"
            private="true"
            version="true"
            use="true"
            windowtitle="${Name} ${version} API"
            doctitle="${Name} ${version} API"
            bottom="Copyright &#169; ${year} &lt;i&gt;melati&lt;/i&gt;. All Rights Reserved."
        />
    </target>
    
    <!-- =================================================================== -->
    <!-- Package as .zip and .tgz                                            -->
    <!-- =================================================================== -->
    <target name="package" depends="jar,javadocs">
        <mkdir dir="${final.dir}"/>
        <zip zipfile="${final.dir}/${Name}_${version}.zip" basedir="${build.built.root}"/>
        <tar tarfile="${final.dir}/${Name}_${version}.tar" basedir="${build.built.root}"/>
        <gzip zipfile="${final.dir}/${Name}_${version}.tar.gz" src="${final.dir}/${Name}_${version}.tar"/>
        <zip zipfile="${final.dir}/${Name}_${version}_doc.zip" basedir="${build.doc.root}"/>
        <tar tarfile="${final.dir}/${Name}_${version}_doc.tar" basedir="${build.doc.root}"/>
        <gzip zipfile="${final.dir}/${Name}_${version}_doc.tar.gz" src="${final.dir}/${Name}_${version}_doc.tar"/>
    </target>
    
    
    <!-- =================================================================== -->
    <!-- Cleans up the build directory                                       -->
    <!-- =================================================================== -->
    <target name="clean">
        <deltree dir="${build.dist}"/>
        <deltree dir="${build.built.root}"/>
        <deltree dir="${build.doc.root}"/>
        <deltree dir="${final.dir}"/>
    </target>
</project>
